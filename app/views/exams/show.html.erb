<% if @questions_for_result.present? %>
  <% questions = @questions_for_result %>
  <% total_questions = questions.size %>
  <% correct_count = @score_from_db.present? ? @score_from_db[:score] : 0 %>

  <div
    class="flex flex-col lg:flex-row lg:h-screen bg-slate-50"
    data-controller="exam-result"
    data-exam-result-total-value="<%= total_questions %>"
    data-exam-result-current-value="0"
  >
    <aside class="lg:w-64 xl:w-72 lg:flex-shrink-0 lg:border-r lg:border-slate-200 lg:overflow-y-auto bg-white">
      <div class="p-4">
        <h2 class="text-base font-semibold text-slate-900">Questions</h2>
        <p class="mt-2 text-sm font-medium text-slate-700"><%= correct_count %> / <%= total_questions %> correct (based on persisted answer key)</p>
        <div class="mt-4 space-y-2 text-xs text-slate-600">
          <p class="flex items-center gap-2">
            <span class="w-4 h-4 rounded-full bg-emerald-500 shrink-0"></span>
            Correct
          </p>
          <p class="flex items-center gap-2">
            <span class="w-4 h-4 rounded-full bg-rose-400 shrink-0"></span>
            Incorrect
          </p>
        </div>
        <p class="mt-3 text-xs text-slate-500 flex items-center gap-1">
          <svg class="w-4 h-4 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>
          Click a question to view details
        </p>
        <div class="mt-4 grid grid-cols-5 gap-1.5">
          <% questions.each_with_index do |q, index| %>
            <% detail = @details_by_qid && @details_by_qid[q["id"].to_i] %>
            <% correct = detail ? detail[:correct] : nil %>
            <button
              type="button"
              class="w-9 h-9 rounded-lg text-sm font-medium transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1 <%= index == 0 ? 'bg-indigo-600 text-white' : correct == true ? 'bg-emerald-500 text-white' : correct == false ? 'bg-rose-400 text-white' : 'bg-slate-200 text-slate-600' %>"
              data-exam-result-target="questionItem"
              data-question-index="<%= index %>"
              data-question-correct="<%= correct.nil? ? '' : correct %>"
              data-action="click->exam-result#goTo"
            >
              <%= index + 1 %>
            </button>
          <% end %>
        </div>
      </div>
    </aside>

    <main class="flex-1 flex flex-col min-h-0 lg:overflow-y-auto">
      <div class="flex-1 p-4 sm:p-6 lg:p-8">
        <% questions.each_with_index do |question, index| %>
          <% detail = @details_by_qid && @details_by_qid[question["id"].to_i] %>
          <% answer_ids = detail ? detail[:user_answers] : [] %>
          <% choices = question["choices"] || [] %>
          <% is_correct = detail ? detail[:correct] : nil %>

          <section
            class="rounded-xl bg-white shadow-sm ring-1 ring-slate-200 overflow-hidden <%= index == 0 ? '' : 'hidden' %>"
            data-exam-result-target="questionPanel"
            data-question-index="<%= index %>"
          >
            <div class="p-6">
              <h3 class="text-lg font-semibold text-slate-900 mb-4">Question <%= index + 1 %></h3>
              <div class="prose prose-slate max-w-none text-slate-700 mb-6">
                <%= simple_exam_markdown(question["question"]) %>
              </div>
              <p class="text-sm font-medium text-slate-600 mb-2">Your answers:</p>
              <ul class="space-y-2">
                <% choices.each do |choice| %>
                  <% selected = answer_ids.include?(choice["id"]) %>
                  <li class="flex items-center gap-3 p-3 rounded-lg border <%= selected ? (is_correct ? 'border-emerald-300 bg-emerald-50' : 'border-rose-300 bg-rose-50') : 'border-slate-200 bg-slate-50' %>">
                    <% if selected %>
                      <% if is_correct %>
                        <span class="flex-shrink-0 w-6 h-6 rounded-full bg-emerald-500 flex items-center justify-center text-white" aria-hidden="true">✓</span>
                      <% else %>
                        <span class="flex-shrink-0 w-6 h-6 rounded-full bg-rose-400 flex items-center justify-center text-white" aria-hidden="true">✗</span>
                      <% end %>
                    <% else %>
                      <span class="flex-shrink-0 w-6 h-6 rounded-full border-2 border-slate-300 bg-white"></span>
                    <% end %>
                    <span class="text-sm font-medium text-slate-800"><%= choice["label"].to_s.strip %></span>
                  </li>
                <% end %>
              </ul>
              <% if answer_ids.blank? || answer_ids.empty? %>
                <p class="mt-2 text-sm text-slate-500">You did not answer this question.</p>
              <% end %>
              <% if detail.present? %>
                <div class="mt-4 p-3 rounded-lg bg-slate-50 border border-slate-200">
                  <p class="text-xs font-medium uppercase tracking-wider text-slate-500 mb-1">Result (persisted answer key)</p>
                  <p class="text-sm font-medium <%= is_correct ? 'text-emerald-700' : 'text-rose-700' %>"><%= is_correct ? "✓ Correct" : "✗ Incorrect" %></p>
                  <% if detail[:description].present? %>
                    <p class="text-xs font-medium uppercase tracking-wider text-slate-500 mt-2 mb-1">Explanation</p>
                    <p class="text-sm text-slate-700"><%= simple_exam_markdown(detail[:description]) %></p>
                  <% end %>
                </div>
              <% end %>
            </div>
          </section>
        <% end %>
      </div>

      <div class="flex-shrink-0 flex items-center justify-between gap-4 p-4 sm:p-6 lg:p-8 border-t border-slate-200 bg-white">
        <button
          type="button"
          class="rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
          data-action="click->exam-result#prev"
        >
          ← Previous
        </button>
        <button
          type="button"
          class="rounded-lg bg-amber-400 hover:bg-amber-500 text-amber-900 px-5 py-2.5 text-sm font-semibold shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2"
          data-action="click->exam-result#next"
        >
          Next →
        </button>
        <%= link_to "Try again", exams_path(exam_code: @hash_id), class: "rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" %>
      </div>
    </main>
  </div>
<% else %>
  <div class="min-h-screen bg-slate-50 flex items-center justify-center p-6">
    <div class="rounded-xl bg-white shadow-sm ring-1 ring-slate-200 p-12 text-center">
      <p class="text-slate-600">Exam or submission not found.</p>
      <%= link_to "Back to exam", exams_path(exam_code: @hash_id), class: "mt-4 inline-block text-sm font-medium text-indigo-600 hover:text-indigo-800" %>
    </div>
  </div>
<% end %>
