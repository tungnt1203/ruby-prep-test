# AGENTS.md — Services

<!-- generated by agents-md-generator | last_generated: 2026-02-12 -->

> Service objects encapsulating business logic that spans multiple models or requires complex orchestration.

## Structure

```
app/services/
└── create_exam_from_bank_service.rb   # Creates exam from question bank
```

## Naming Conventions

| Element | Pattern | Example |
|---------|---------|---------|
| Service file | `{action}_{resource}_service.rb` | `create_exam_from_bank_service.rb` |
| Service class | `{Action}{Resource}Service` | `CreateExamFromBankService` |
| Entry method | `call` | `def call` |
| Custom errors | `Error` inner class | `class Error < StandardError; end` |

## Rules

### Do

- Add `# frozen_string_literal: true` as first line
- Define a single `call` method as the entry point
- Accept parameters via `initialize`
- Wrap multi-step operations in `ActiveRecord::Base.transaction`
- Define custom `Error` class for service-specific failures
- Return a hash or result object with consistent structure

### Don't

- Don't access `session`, `params`, or `request` — those are controller concerns
- Don't render views or redirect — return data, let controller handle response
- Don't call other services excessively — keep services focused
- Don't put model validations in services — validations belong in models

## Patterns

### ✅ Good — Service with call method and transaction

```ruby
class CreateExamFromBankService
  class Error < StandardError; end

  def initialize(questions_count: 50)
    @questions_count = questions_count
  end

  def call
    bank_questions = BankQuestion.order("RANDOM()").limit(@questions_count)
    raise Error, "Not enough questions" if bank_questions.size < @questions_count

    ExamSession.transaction do
      session = ExamSession.create!(...)
      bank_questions.each { |bq| copy_to_exam(session, bq) }
      { exam_session: session, hash_id: session.hash_id }
    end
  end

  private

  def copy_to_exam(session, bank_question)
    # ...
  end
end
```

### ❌ Bad — Service with controller logic

```ruby
class CreateExamService
  def call
    # ... create exam ...
    redirect_to exam_path(@exam)  # Don't do this
  end
end
```

## Related Files

| File | Relationship |
|------|-------------|
| `AGENTS.md` (project root) | Global rules and decision tree — read first |
| `app/controllers/AGENTS.md` | Controllers call services for business operations |
| `app/models/AGENTS.md` | Services use models for data access |

## Checklist — New Service

Before creating a new service:

- [ ] File named `{action}_{resource}_service.rb` in `app/services/`
- [ ] `# frozen_string_literal: true` as first line
- [ ] Single `call` method as entry point
- [ ] Parameters via `initialize`
- [ ] Custom `Error` class if service can fail
- [ ] Transaction wrapping for multi-model operations
